# Caddyfile with rate limiting for Travel Ticker
# Uses caddy-ratelimit plugin: https://github.com/mholt/caddy-ratelimit

{
	# Global options
	admin off

	# Rate limit configuration
	order rate_limit before basicauth
	# Cache ordering - placing it before reverse_proxy allows us to use 
	# standard matchers/rewrites to protect the API if needed
	order cache before reverse_proxy
}

{$CADDY_DOMAIN:localhost} {
	# Filter logs to reduce noise (only show warnings and errors)
	log {
		level WARN
	}

	# Enable compression
	encode gzip zstd

	# Rate limiting configuration
	# All zones are evaluated - requests must pass all matching zones
	rate_limit {
		# Global rate limit: 100 requests per second per IP
		# Protects against general flooding
		zone global {
			key {remote_host}
			events 100
			window 1s
		}

		# Stricter limits for authentication endpoints
		# 10 requests per minute per IP (prevents brute force)
		zone auth {
			match {
				path /login /register /forgot-password /reset-password /verify-email
			}
			key {remote_host}
			events 10
			window 1m
		}

		# API endpoints: 60 requests per minute per IP
		zone api {
			match {
				path /api/*
			}
			key {remote_host}
			events 60
			window 1m
		}
	}
	cache {
		# Default TTL for cached content
		ttl 60s
		# Serve stale content for up to 300s if backend is down
		stale 300s
		
		# Exclude uploads (images/videos) from in-memory cache
		# These are large and will fill up memory quickly
		regex {
			exclude /api/uploads/.*
		}
	}

	# Protect Souin API (only allow internal IPs)
	@souin_api {
		path /souin-api/*
	}
	handle @souin_api {
		@deny_external {
			not remote_ip 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.1/8
		}
		respond @deny_external 403
	}

	
	# Reverse proxy to the application
	reverse_proxy travel-ticker:3000 {
		# X-Sendfile implementation:
		# If backend sends "X-Accel-Redirect", serve the file directly from Caddy
		# keeping the backend efficient/stateless for large downloads.
		@accel header X-Accel-Redirect *
		handle_response @accel {
			root * /internal-data/uploads
			# Rewrite request to /<filename> using the header value
			# The backend now sends just "filename.ext" (no slash)
			rewrite * /{header.X-Accel-Redirect}
			header Cache-Control "public, max-age=31536000, immutable"
			file_server
		}
	}

	# Security headers
	header {
		-Server
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		# HSTS: Enforce HTTPS for 1 year, include subdomains, allow preload list
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}

	# Logging
	log {
		output stdout
		format json
	}
}
