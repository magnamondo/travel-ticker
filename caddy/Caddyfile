# Caddyfile with rate limiting for Travel Ticker
# Uses caddy-ratelimit plugin: https://github.com/mholt/caddy-ratelimit
{
	admin off
	log {
		level WARN
	}
	order rate_limit before basicauth
}

{$CADDY_DOMAIN:localhost} {
	encode gzip zstd

	rate_limit {
		zone global {
			key {remote_host}
			events 100
			window 1s
		}
		zone auth {
			match {
				path /login /register /forgot-password /reset-password /verify-email
			}
			key {remote_host}
			events 10
			window 1m
		}
		zone upload {
			match {
				path /api/upload /api/upload/*
			}
			key {http.request.cookie.auth-session}
			events 1200
			window 1m
		}
		zone client_error {
			match {
				path /api/client-error
			}
			key {remote_host}
			events 10
			window 1m
		}
	}

	# Block Next.js exploit attempts (CVE-2025-29927)
	@nextjs_exploit header X-Middleware-Subrequest *
	respond @nextjs_exploit 403

	# Reject protected endpoints without auth cookie
	@no_auth_cookie {
		path /api/upload/* /admin/*
		not header Cookie *auth-session*
	}
	respond @no_auth_cookie 401

	reverse_proxy travel-ticker:3000 {
		@accel header X-Accel-Redirect *
		handle_response @accel {
			root * /internal-data/uploads
			rewrite * {rp.header.X-Accel-Redirect}
			method * GET
			header Cache-Control "public, max-age=31536000, immutable"
			file_server
		}
	}

	header {
		-Server
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}

	log {
		output stdout
		format json
		level ERROR
	}
}
