#cloud-config
# Hetzner Cloud-Init for Debian with Docker, fail2ban, and security hardening
# Usage: Paste this into the "Cloud config" field when creating a Hetzner server

# Set hostname
hostname: mm-tt

# System settings
timezone: UTC

# Create a non-root user with sudo access
# SSH keys selected in Hetzner GUI are automatically added to this user
users:
  - name: deploy
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_import_id: []

# Disable root login and password auth
ssh_pwauth: false

# Package management
package_update: true
package_upgrade: true
package_reboot_if_required: true

packages:
  # Security
  - fail2ban
  - ufw
  - unattended-upgrades
  - apt-listchanges
  # Utilities
  - curl
  - wget
  - git
  - htop
  - vim
  - tmux
  - jq
  - ncdu
  # Docker dependencies
  - ca-certificates
  - gnupg
  - lsb-release

# Write configuration files
write_files:
  # Optimize UDP buffers for HTTP/3 (QUIC)
  - path: /etc/sysctl.d/20-http3.conf
    content: |
      net.core.rmem_max=7500000
      net.core.wmem_max=7500000

  # fail2ban SSH jail configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 5
      banaction = ufw

      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 24h
    permissions: '0644'

  # SSH hardening configuration
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    content: |
      # Disable root login
      PermitRootLogin no

      # Disable password authentication
      PasswordAuthentication no
      ChallengeResponseAuthentication no

      # Use key-based authentication only
      PubkeyAuthentication yes

      # Disable empty passwords
      PermitEmptyPasswords no

      # Disable X11 forwarding
      X11Forwarding no

      # Limit authentication attempts
      MaxAuthTries 3

      # Set login grace time
      LoginGraceTime 30

      # Disable unused authentication methods
      KerberosAuthentication no
      GSSAPIAuthentication no
    permissions: '0644'

  # Unattended upgrades configuration
  - path: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}";
          "${distro_id}:${distro_codename}-security";
          "${distro_id}:${distro_codename}-updates";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
    permissions: '0644'

  # Enable automatic updates
  - path: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    permissions: '0644'

  # Sysctl security tweaks
  - path: /etc/sysctl.d/99-security.conf
    content: |
      # IP Spoofing protection
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1

      # Ignore ICMP broadcast requests
      net.ipv4.icmp_echo_ignore_broadcasts = 1

      # Disable source packet routing
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv4.conf.default.accept_source_route = 0
      net.ipv6.conf.all.accept_source_route = 0
      net.ipv6.conf.default.accept_source_route = 0

      # Ignore send redirects
      net.ipv4.conf.all.send_redirects = 0
      net.ipv4.conf.default.send_redirects = 0

      # Block SYN attacks
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_max_syn_backlog = 2048
      net.ipv4.tcp_synack_retries = 2
      net.ipv4.tcp_syn_retries = 5

      # Log Martians
      net.ipv4.conf.all.log_martians = 1
      net.ipv4.icmp_ignore_bogus_error_responses = 1

      # Ignore ICMP redirects
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0
      net.ipv6.conf.all.accept_redirects = 0
      net.ipv6.conf.default.accept_redirects = 0

      # Disable IPv6 if not needed (uncomment if desired)
      # net.ipv6.conf.all.disable_ipv6 = 1
      # net.ipv6.conf.default.disable_ipv6 = 1
    permissions: '0644'

  # Docker daemon configuration
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "live-restore": true,
        "userns-remap": "default"
      }
    permissions: '0644'

# Run commands after boot
runcmd:
  # Copy root's SSH keys to deploy user (Hetzner adds keys to root)
  - mkdir -p /home/deploy/.ssh
  - cp /root/.ssh/authorized_keys /home/deploy/.ssh/authorized_keys
  - chown -R deploy:deploy /home/deploy/.ssh
  - chmod 700 /home/deploy/.ssh
  - chmod 600 /home/deploy/.ssh/authorized_keys

  # Apply sysctl settings
  - sysctl --system

  # Configure UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 443/udp   # HTTP/3 (QUIC)
  - ufw --force enable

  # Install Docker using official script
  - curl -fsSL https://get.docker.com | sh

  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker

  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Restart SSH to apply hardening
  - systemctl restart sshd

  # Clean up
  - apt-get autoremove -y
  - apt-get clean

# Final message
final_message: |
  Cloud-init completed after $UPTIME seconds.
  Docker version: $(docker --version)
  System is ready for deployment.
